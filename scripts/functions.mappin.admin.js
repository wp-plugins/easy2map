var easy2map_mappin_functions=(function(){clearPinArray=function(){if($pinsArray){for(i in $pinsArray){$pinsArray[i].setMap(null);$pinsArray[i].setAnimation(null)}}if($pinsArray){$pinsArray.length=0}$selectedPin=null};addPinToMap=function(a){this.selectedMapPoint=a;var b=new google.maps.Marker({position:new google.maps.LatLng(this.selectedMapPoint.lattitude,this.selectedMapPoint.longitude),draggable:true,map:$map,title:this.selectedMapPoint.title.replace(/\\/gi,""),ID:this.selectedMapPoint.ID,icon:this.selectedMapPoint.icon,settings:this.selectedMapPoint.settings,pinHTML:this.selectedMapPoint.pinhtml});$pinsArray.push(b);google.maps.event.addListener(b,"dragend",function(c){$latlng=c.latLng;showLatLong();updateMapPinLocation(b.ID)});google.maps.event.addListener(b,"click",function(g){var c=b.pinHTML.split("\n");var d="";for(var f=0;f<c.length;f++){if(f>0){d+="<br>"}d+=c[f]}var e=new google.maps.InfoWindow();e.setContent(d);e.open(b.map,b)})};listedMapPin=function(a){this.pinDetails=a};setPinImage=function(a){jQuery("#draggable").attr("src",jQuery(a).attr("src"));jQuery("#mapPinIconList").modal("hide");if($pinsArray){for(i in $pinsArray){if(typeof $pinsArray[i].ID=="undefined"||typeof $selectedPin.ID=="undefined"){continue}if($pinsArray[i].ID==$selectedPin.ID){$pinsArray[i].setIcon(jQuery(a).attr("src"))}}}};showLatLong=function(){jQuery("#latLongParent").show();jQuery("#divLatLong").html("Position of Pin: "+$latlng)};updateMapPinLocation=function(a){jQuery.ajax({type:"POST",url:ajaxurl,dataType:"json",data:{mapPointID:a,latLong:$latlng+"",action:"update_map_pin_location"}})};return{addNewMapMarker:function(){jQuery("#AddMarkerOrSave").hide();jQuery("#tblAddMapMarker").show()},cancelSaveMapPin:function(){jQuery("#pinNameParent").hide();jQuery("#pinDescriptionParent").hide();jQuery("#divAddressSearch").show();jQuery("#btnCancelPin").hide();jQuery("#AddMarkerOrSave").hide();jQuery("#tblAddMapMarker").hide();jQuery("#address").attr("placeholder","Enter Marker's Address");document.getElementById("mapSize").disabled=false;jQuery("#draganddrop").show();jQuery("#AddEditPinTitle").html("Add New Marker");jQuery("#divDrag").show();jQuery("#divPinAddEditParent").hide();jQuery("#pinName").val("");jQuery("#pinDescription").data("wysihtml5").editor.clear();jQuery("#btnDeletePin").hide();jQuery("#btnSavePin").hide();jQuery("#latLongParent").hide();jQuery("#draggable").attr("src",$mapSettings.DefaultPinImage);if($selectedPin){$selectedPin.setAnimation(null)}$selectedPin=null;easy2map_mappin_functions.setIconDraggable();jQuery("td [id ^= imageTd]").removeClass("highlighted");jQuery("td [id ^= nameTd]").removeClass("highlighted");if($pinsArray){for(i in $pinsArray){if($pinsArray[i].ID==0){$pinsArray[i].setMap(null);$pinsArray[i].setAnimation(null);$pinsArray.splice(i,1)}}}jQuery("tr [id ^=divPinInstructions]").show();jQuery("#draganddrop").show();$mapPinID=0},changeMapPinTemplate:function(){var a=parseInt(jQuery("#MapPinTemplateName").val());for(var b=0;b<$arrTemplates.length;b++){var c=$arrTemplates[b];if(parseInt(c.ID)==a){jQuery("#MapTemplateExampleImg").html(c.TemplateHTML)}}},deleteSelectedPoint:function(){if(!confirm("Are you sure you wish to delete this pin? This action is not reversible!")){return}jQuery.ajax({type:"POST",url:ajaxurl,dataType:"json",data:{MapPointID:$mapPinID,action:"delete_map_point"},success:function(a){if(a.length>0){alert(a);return}clearPinArray();if($pinsArray){$pinsArray.length=0}easy2map_mappin_functions.retrieveMapPoints()},error:function(a,c,b){if(b.length>0){alert(b)}}})},editPinItem:function(b){var a=$markersArray[b].pinDetails;$latlng=new google.maps.LatLng(a.lattitude,a.longitude);$selectedPin=$pinsArray[b];showLatLong();$selectedPin.setAnimation(google.maps.Animation.BOUNCE);setTimeout(function(){$selectedPin.setAnimation(null)},1500);jQuery("td [id ^= imageTd]").removeClass("highlighted");jQuery("td [id ^= nameTd]").removeClass("highlighted");jQuery("#imageTd"+b).addClass("highlighted");jQuery("#nameTd"+b).addClass("highlighted");document.getElementById("mapSize").disabled=true;jQuery("#pinNameParent").show();jQuery("#pinDescriptionParent").show();jQuery("#divAddressSearch").show();jQuery("#address").attr("placeholder","Change Marker's Location");jQuery("#AddMarkerOrSave").hide();jQuery("#tblAddMapMarker").show();jQuery("#draganddrop").hide();jQuery("#btnCancelPin").show();jQuery("#AddEditPinTitle").html("Edit Marker's Details");jQuery("#btnUploadIcon").html("Change Icon");jQuery("#divDrag").hide();jQuery("#divPinAddEditParent").show();jQuery("#pinName").val(a.title.replace(/\\/gi,""));jQuery("#pinDescription").data("wysihtml5").editor.setValue(a.pinhtml);$mapPinID=a.ID;jQuery("#btnDeletePin").show();jQuery("#btnSavePin").show();jQuery("tr [id ^=divPinInstructions]").hide();jQuery("#draggable").attr("src",a.icon);easy2map_mappin_functions.setIconNotDraggable()},hidePreviewPage:function(){jQuery("#divMultipleLocations").fadeOut()},openImagesDirectory:function(a){jQuery.ajax({type:"POST",url:ajaxurl,dataType:"json",data:{mapID:$mapID,action:"retrieve_pin_icons"},success:function(e){jQuery("#tblPinImages").find("tr").remove();var b=0;for(var d=0;d<e.length;d++){if(b%6==0){var f=document.createElement("tr");document.getElementById("tblPinImages").appendChild(f)}var c=document.createElement("td");c.align="center";c.style.borderColor="#FFFFFF";c.style.padding="2px";if(e[d]==a){c.style.borderColor="#EBEBEB";c.style.borderWidth="2px";c.style.borderStyle="solid";c.style.borderRadius="3px"}var g=document.createElement("img");g.style.cursor="pointer";g.setAttribute("onClick","easy2map_mappin_functions.setMapPinImage(this)");g.src=e[d];c.appendChild(g);f.appendChild(c);b+=1}jQuery("#mapPinIconList").modal()},error:function(b,d,c){alert(c)}})},placePin:function(b){var a=new google.maps.Marker({position:b,ID:0,draggable:true,bouncy:true,title:"Click on icon to edit details",map:$map,icon:jQuery("#draggable").attr("src")});$latlng=a.position;$pinsArray.push(a);$selectedPin=$pinsArray[$pinsArray.length-1];showLatLong();jQuery("#pinNameParent").show();jQuery("#pinDescriptionParent").show();jQuery("#divAddressSearch").hide();document.getElementById("mapSize").disabled=true;jQuery("#draganddrop").hide();jQuery("#btnCancelPin").show();jQuery("#AddEditPinTitle").html("Set Marker's Details");jQuery("#btnUploadIcon").html("Change Icon");jQuery("#address").attr("placeholder","Change Marker's Location");jQuery("#divDrag").hide();jQuery("#divPinAddEditParent").show();jQuery("tr [id ^=divPinInstructions]").hide();jQuery("#pinName").focus();jQuery("#btnSavePin").show();easy2map_mappin_functions.setIconNotDraggable();google.maps.event.addListener(a,"dragend",function(c){$latlng=c.latLng;showLatLong()});google.maps.event.addListener(a,"click",function(c){$latlng=c.latLng;showLatLong()})},retrieveMapPoints:function(){var a={action:"retrieve_map_points",MapID:$mapID};easy2map_mappin_functions.cancelSaveMapPin();jQuery.ajax({type:"POST",url:ajaxurl,data:a,dataType:"json",success:function(f){jQuery("#tblMapMarkers").show().find("tr").remove();jQuery("#divAddressSearch").show();var d=false;if(typeof f=="undefined"||typeof f=="null"){d=true}if(!f){d=true}if(f.length==0){d=true}if(d){jQuery("#AddMarkerOrSave").hide();jQuery("#tblAddMapMarker").show();jQuery("#MarkersListHeading").html("");return}else{jQuery("#AddMarkerOrSave").show();jQuery("#tblAddMapMarker").hide();jQuery("#MarkersListHeading").html("<h6>Map Markers</h6>")}if($markersArray){$markersArray.length=0}clearPinArray();for(var n=0;n<f.length;n++){var m=replaceAll(replaceAll(replaceAll(f[n].LatLong," ",""),"(",""),")","").split(",");var o={lattitude:m[0],longitude:m[1],ID:f[n].ID,title:f[n].Title,icon:f[n].ImageURL,settings:f[n].Settings,pinhtml:f[n].MapPinHTML};$markersArray.push(new listedMapPin(o))}for(var j=0;j<$markersArray.length;j++){var h=$markersArray[j].pinDetails;addPinToMap(h);var l=document.createElement("tr");document.getElementById("tblMapMarkers").appendChild(l);var g=document.createElement("td");g.id="imageTd"+j;g.align="center";var e=document.createElement("img");e.style.cursor="pointer";e.setAttribute("onClick","easy2map_mappin_functions.editPinItem("+j+")");e.src=h.icon;g.style.minWidth="30px";g.style.textAlign="center";g.appendChild(e);var c=document.createElement("td");c.id="nameTd"+j;c.innerHTML=h.title.replace(/\\/gi,"");c.style.width="80%";c.style.cursor="pointer";c.setAttribute("onClick","easy2map_mappin_functions.editPinItem("+j+")");var k=document.createElement("td");k.id="editTd"+j;k.style.minWidth="10%";k.style.textAlign="center";var b=document.createElement("a");b.innerText="edit";b.textContent="edit";b.href="#";b.setAttribute("className","smallE2MLink");b.setAttribute("onclick","easy2map_mappin_functions.editPinItem("+j+")");k.appendChild(b);l.appendChild(g);l.appendChild(c);l.appendChild(k)}jQuery("#tblMapMarkers").removeClass("table-striped").addClass("table-striped")}})},saveMapPin:function(){var a=jQuery("#pinDescription").val();a=replaceAll(a,"&quot;Arial&quot;","Arial");a=replaceAll(a,"&quot;Times New Roman&quot;","Arial");a=replaceAll(a,"&quot;sans-serif&quot;","sans-serif");a=replaceAll(a,'class="MsoNormal"',"");a=a.replace(/ â€“ /g," - ");a=replaceAll(a,"line-height:","min-height:");if(a.indexOf("<p")!=-1){a=replaceAll(a,"'","&#39;")}a=replaceAll(a,"<p>",'<p style="margin:0; padding:0;">');a=replaceAll(a,'<p style="text-align: left;">','<p style="text-align: left;margin:0; padding:0;">');a=replaceAll(a,'<p style="text-align: right;">','<p style="text-align: left;margin:0; padding:0;">');a=replaceAll(a,'<p style="text-align: center;">','<p style="text-align: left;margin:0; padding:0;">');if(a.indexOf("[endif]")!=-1){a=a.substring(a.lastIndexOf("[endif]")+10)}jQuery.ajax({type:"POST",url:ajaxurl,dataType:"json",data:{mapPointID:$mapPinID,action:"save_map_pin",latLong:$latlng+"",icon:jQuery("#draggable").attr("src"),pinTitle:jQuery("#pinName").val(),pinSettingsXML:"",pinHTML:a,mapID:$mapID},success:function(b){easy2map_mappin_functions.retrieveMapPoints();$selectedPin=null},error:function(b,d,c){alert(c)}})},setCurrentPosition:function(c,b){var a=new google.maps.LatLng(c,b);$latlng=a},setMapPinImage:function(a){jQuery.ajax({type:"POST",url:ajaxurl,dataType:"json",data:{MapID:$mapID,PinImage:encodeURIComponent(jQuery(a).attr("src")),action:"save_default_pin_image"},success:function(b){jQuery("#draggable").attr("src",jQuery(a).attr("src"));jQuery("#mapPinIconList").modal("hide");$mapSettings.DefaultPinImage=b;setPinImage(a)},error:function(b,d,c){alert(c)}})},SetPinPosition:function(e,c){var a=new google.maps.LatLng(e,c);$latlng=a;if($selectedPin==null){easy2map_mappin_functions.placePin(a);if($markersArray.length==0){$map.setCenter(a);$map.setZoom(12);var d=jQuery.xml2json($mapSettings.Settings);d.lattitude=e;d.longitude=c;d.zoom=$map.getZoom();var b={formatOutput:true,rootTagName:"settings"};$mapSettings.Settings=jQuery.json2xml(d,b)}}else{$selectedPin.setPosition(a)}setTimeout("jQuery('#address').val('')",1500)},setIconDraggable:function(){jQuery("#draggable").css("cursor","move");jQuery("#draggable").draggable({appendTo:"#bodyTag",scroll:false,helper:"clone",stop:function(h){var g=$map.getBounds();var d=g.getSouthWest();var c=g.getNorthEast();var b=jQuery("#divMap").offset();var a=new google.maps.Point(h.pageX-b.left,h.pageY-b.top+22);var f=$overlay.getProjection().fromContainerPixelToLatLng(a);if(d.lng()>0&&(f.lng()>0&&f.lng()<d.lng())){return}if(d.lng()<0&&(f.lng()<0&&f.lng()<d.lng())){return}if(c.lng()>0&&(f.lng()>0&&f.lng()>c.lng())){return}if(c.lng()<0&&(f.lng()<0&&f.lng()>c.lng())){return}easy2map_mappin_functions.placePin(f)}})},setIconNotDraggable:function(){jQuery("#draggable").css("cursor","default").draggable("destroy")},uploadPinIcon:function(){var a=checkFileExtensionSilent(document.getElementById("pinicon"));if(a!=""){alert("Invalid file, only the following image types are allowed: "+a+". Please upload a different image.");return}document.formAddPinIcon.submit()}}})();